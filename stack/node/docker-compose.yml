version: '3.6'

services:
    consul:
        image: consul:latest
        labels:
          - SERVICE_8300_IGNORE=true
          - SERVICE_8301_IGNORE=true
          - SERVICE_8302_IGNORE=true
          - SERVICE_8500_NAME=${COMPOSE_SERVICE_NAME}-consul-8500
          - SERVICE_8500_CHECK_TCP=true
          - SERVICE_8500_CHECK_INITIAL_STATUS=passing
          - SERVICE_8500_TAGS=${SERVICE_CONSUL_HTTP_TAGS}
          - SERVICE_8600_IGNORE=true
        networks:
          - frontend
        ports:
          - 8500:8500
        restart: always
        volumes:
          - consul:/consul/data
    fabio:
        image: fabiolb/fabio:latest
        command: /fabio -registry.backend "consul" -registry.consul.addr "consul:8500" -proxy.addr ":80,:443;cs=local" -proxy.cs "cs=local;type=file;cert=/certs/${SSL_HOSTNAME}.crt;key=/certs/${SSL_HOSTNAME}.key"
        depends_on:
          - consul
        labels:
          - SERVICE_80_NAME=${COMPOSE_SERVICE_NAME}-fabio-80
          - SERVICE_80_CHECK_TCP=true
          - SERVICE_80_CHECK_INITIAL_STATUS=passing
          - SERVICE_443_NAME=${COMPOSE_SERVICE_NAME}-fabio-443
          - SERVICE_443_CHECK_TCP=true
          - SERVICE_443_CHECK_INITIAL_STATUS=passing
          - SERVICE_9998_NAME=${COMPOSE_SERVICE_NAME}-fabio-9998
          - SERVICE_9998_CHECK_TCP=true
          - SERVICE_9998_CHECK_INITIAL_STATUS=passing
          - SERVICE_9998_TAGS=${SERVICE_FABIO_ADMIN_HTTP_TAGS}
          - SERVICE_9999_IGNORE=true
        networks:
          - frontend
        ports:
          - 80:80
          - 443:443
          - 9998
        restart: always
        volumes:
          - ssl-certs:/certs
    registrator:
        image: gliderlabs/registrator:latest
        command: -internal -cleanup=true -deregister always -resync=30 consul://consul:8500
        depends_on:
          - consul
        networks:
          - frontend
        restart: always
        volumes:
          - /var/run/docker.sock:/tmp/docker.sock

volumes:
    consul:
    ssl-certs:

networks:
    frontend:
        external: true
        name: node
