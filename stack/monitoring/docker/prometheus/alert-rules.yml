groups:
- name: example
  rules:

  # CET / CEST
  - record: is_european_summer_time
    expr: |
      (vector(1) and (month() > 3 and month() < 10))
      or
      (vector(1) and (month() == 3 and (day_of_month() - day_of_week()) >= 25) and absent((day_of_month() >= 25) and (day_of_week() == 0)))
      or
      (vector(1) and (month() == 10 and (day_of_month() - day_of_week()) < 25) and absent((day_of_month() >= 25) and (day_of_week() == 0)))
      or
      (vector(1) and ((month() == 10 and hour() < 1) or (month() == 3 and hour() > 0)) and ((day_of_month() >= 25) and (day_of_week() == 0)))
      or
      vector(0)
  # French time (UTC+1) CET / CEST
  - record: european_french_time
    expr: time() + 3600 + 3600 * is_european_summer_time

  # Alert for any instance that is unreachable for a few seconds.
  - alert: InstanceDown-01-low
    expr: probe_success == 0
    for: 30s
    labels:
      severity: "low"
      type: "timeout"
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "Instance {{ $labels.instance }} of job {{ $labels.job }} has been down for a few seconds."

  # Alert for any instance that is unreachable for some time.
  - alert: InstanceDown-02-medium
    expr: probe_success == 0
    for: 5m
    labels:
      severity: "medium"
      type: "timeout"
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "Instance {{ $labels.instance }} of job {{ $labels.job }} has been down for 10 minutes"

  # Alert for any instance that is unreachable for a long time.
  - alert: InstanceDown-03-high
    expr: probe_success == 0
    for: 1h
    labels:
      severity: "high"
      type: "timeout"
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "Instance {{ $labels.instance }} of job {{ $labels.job }} has been down for 1 hour"

  # Alert for any instance that is unreachable for a very long time.
  - alert: InstanceDown-04-critical
    expr: probe_success == 0
    for: 12h
    labels:
      severity: "critical"
      type: "timeout"
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "Instance {{ $labels.instance }} of job {{ $labels.job }} has been down for more than 12 hours"

  # Alert for GMV < 250€ from 8AM to 10PM on weekdays
  - alert: GMV-daily-high
    # Prometheus time is GMT
    expr: gmv_hourly_return_value < 250 and ON() hour(european_french_time) > 8 < 22
    for: 1h
    labels:
      severity: "high"
      type: "lower than 250€"
      instance: "Hourly GMV"
    annotations:
      summary: "{{ $labels.instance }} down"
      description: "{{ $labels.instance }} has been {{ $labels.type }} for more than 12 hours"

  # Alert for GMV < 250€ from 8AM to 10PM on weekdays
  - alert: GMV-daily-critical
    # Prometheus time is GMT
    expr: gmv_hourly_return_value < 250 and ON() hour(european_french_time) > 8 < 22
    for: 12h
    labels:
      severity: "critical"
      type: "lower than 250€"
      instance: "Hourly GMV"
    annotations:
      summary: "{{ $labels.instance }} down"
      description: "{{ $labels.instance }} has been {{ $labels.type }} for more than 12 hours"

